<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<link href="https://api.mapbox.com/mapbox-assembly/v1.0.1/assembly.min.css" rel="stylesheet">

<style>
	body { margin: 0; padding: 0; font-family:sans-serif;}
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }

	#modal {
		position:absolute;
		left: 0px;
		bottom: 0px;	
		background:white;
		padding:20px;
		margin:10px;
		border-radius:5px;
		min-width:300px;
	}

	#countyModal {
		left:0;
		top:0;
		position:absolute;
		z-index: 99;
		width:100%;
	}

	label {
		margin-right:10px;
	}

	.mapboxgl-popup * {
		pointer-events: none;
	}
	
	.mapboxgl-popup-content {
		padding: 6px;
	}

	body[mode="county"] #modal,
	#countyModal{
		display:none;
	}

	body[mode="county"] #countyModal {
		display:block;
	}

	canvas {
		cursor:pointer;
	}
	.toggle-group {
		background:#eee;
		width:100%;
	}

	.toggle {
		/*display:inline-block;*/
		white-space: nowrap;
	}

	input:checked+.toggle {
		background:#507fa1;
	}
	label {
		margin:0;
	}
</style>
</head>
<body>
	<div id='countyModal' class='px24 py24'>
		<div id='county' style='float:right'>
			<div id='statistic' style='text-align:right'></div>
		</div>
		<button 
			onclick='state.view = "national"; updateVis("view"); tooltip.remove()' 
			style='display:block; background:#507fa1; color:white; padding:5px'>
			Back
		</button>
		<div class='txt-h1' id='countyLabel'></div>
		<div class='txt-h3' id='stateLabel'></div>
	</div>
	<div id="map"></div>
	<div id='modal'>
		<div id='national'>
			<div class='txt-h5'>Visualize</div>
			<div id='visualize' class='toggle-group' style='margin-bottom:20px'>
				
			</div>
			<div class='txt-h5'>Product</div>
			<div id='product' class='toggle-group' style='margin-bottom:20px'>
				
			</div>
			<div class='txt-h5'>Scenario</div>
			<div id='scenario' class='toggle-group'></div>
		</div>

	</div>

<script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>

<script src='map.js'></script>
<script>

	mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJxbGl1IiwiYSI6ImNrbmdoM2d0cDBjeXAydnBjcTFvcDV4YWIifQ._dh1WoYUQQxa8qzjNXEPRQ';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/peterqliu/ckoox661f9qim17lj6qddz0yf', // style URL
        center: [-100, 40], // starting position [lng, lat]
        zoom: 4 // starting zoom
    });

    var tooltip = new mapboxgl.Popup({ closeButton: false, closeOnClick:false, anchor:'left' })
    	.addTo(map)

    var constants = {

    	barGraphAngle: 20,
    	graphColors: ['#7D6B7D', '#FF8C64', '#FFF4BD', '#FF665A'],
    	toggles: ['product', 'scenario', 'visualize', 'statistic'],

    	products: ['Oil', 'Gas'], 
    	scenarios: ['SDS', 'SSP4', 'STPS'],
    	visualizes: ['By %', '% and Volume'],
    	layerModes: [
    		'counties',
    		'stranded-volume-circle',
    		'stranded-volume'
    	],
    	circleRadiusCoefficient: {
    		Oil: 1,
    		Gas: 0.1
    	},
    	statistics: ['production', 'expenditure', 'tax'],
    	countyStats: {
    		production: 'Gross production',
    		expenditure: 'Private expenditure reduction',
    		tax: 'Tax revenue reduction'
    	},
    	decades: ['2020-29', '2030-39', '2040-49'],
    	graphRows: ['baseline', 'STPS', 'SSP4', 'SDS']

    }

    var state = {
    	product: 'Oil',
    	scenario: 'SDS',
    	visualize: 'By %',
    	statistic:'production',
    	view: 'national'
    }


    constants.toggles.forEach(category=> {

    	const categoryOptions = constants[category+'s'];
    	const options = 
			d3.select(`#${category}`)
				.selectAll('button')
				.data(categoryOptions)
				.enter()
				.append('label')
				.attr('class', 'toggle-container w-1/' +categoryOptions.length)
				.on('click', d=> {
					state[category] = d;
					updateVis(category)
				})

			options
				.append('input')
				.attr('type', 'radio')
				.attr('id', d=>d)
				.attr('name', category)
				.attr('value', d=>d)
				.attr('class', 'toggle-1')
				.attr('checked', (d,i)=>i===0 ? 'checked': undefined)


			options
				.append('div')
				.attr('class', category ==='statistic' ? 'toggle txt-h3' : 'toggle')
				.text(d=>constants.countyStats[d] || d)

    })

    const updateVis = category => {

    	// toggling view between national and county
    	if (category === 'view') {

    		d3.select('body')
    			.attr('mode', state.view);

    		const nationalView = state.view === 'national'
    		var [s, c] = state.countyData.location.split('_');

    		map
    			.setFilter('counties', ['all', ['==', 's', s], ['==', 'c', c]])
    			.setPaintProperty(
    				'counties', 
    				'fill-color', 
    				nationalView ? 'white' : '#eff0f0' 
    			)
    			.setPaintProperty(
    				'states-9kg7xn', 
    				'fill-color', 
    				nationalView ? '#eff0f0' : '#c2cdd6'
    			)
	    		.setLayoutProperty('stat-label', 'visibility', nationalView ? 'visible' : 'none')

    		if (nationalView) {
    			updateVis('visualize')
    			map.easeTo({
    				pitch:0, 
    				zoom:4, 
    				bearing:0,
    				easing:t=>t
    			});
    			generateBarGeometry() // clear geometry
    			updateBarGraphLayers(true)
    		}

    		else {
	    		constants.layerModes
	    			.forEach((l,i)=>map.setLayoutProperty(l, 'visibility', l ==='counties' ? 'visible' : 'none'))
    			return
    		}
    	}

    	// toggling stranded data vis scheme
    	else if (category === 'visualize') {

    		const index = constants.visualizes.indexOf(state.visualize);

    		constants.layerModes
    			.forEach((l,i)=>map.setLayoutProperty(l, 'visibility', i===index ? 'visible' : 'none'))
    		map.easeTo({pitch: index === 2 ? 60 : 0})
    		return
    	}

    	// toggling county stat to visualize (without changing county)
    	else if (category === 'statistic') {
    		updateBarGraphLayers();
    		// map.setPaintProperty('counties', 'fill-opacity', 0)
    		return
    	}

    	// toggling scenario and products
    	const prop = `${state.product}${state.scenario}`;
    	const onlyWithLoss = ['>', prop, 0.005];

    	const colorRamp = [
    		"interpolate",
			["linear"],["get", prop],
			0,"#ffd84d",
			1,"#dd2727"
		]
		map
		.setFilter(
			'counties', 
			onlyWithLoss
		)
		.setPaintProperty(
			'counties',
			'fill-color',
			colorRamp
		)
		.setFilter(
			'stranded-volume-circle', 
			onlyWithLoss
		)
		.setPaintProperty(
			'stranded-volume-circle', 
			'circle-radius', 
			// ["get",`${prop}Vol`],
			[
				'interpolate', ['exponential', 2], ['zoom'],
				4, ['*', ["sqrt",["get",`${prop}Vol`]], 1],
				22, ['*', ["sqrt",["get",`${prop}Vol`]], 160000],
			]
			
		)
		.setPaintProperty(
			'stranded-volume-circle',
			'circle-color',
			colorRamp
		)
		.setPaintProperty(
			'stranded-volume-circle',
			'circle-stroke-color',
			colorRamp
		)
		.setLayoutProperty(
			'stat-label',
			'text-field',
			["concat",
				["get", 'c'], 
				// ' ',
				// prop+'Vol',
				' ', 
				["to-string",
					["round",
						["*",
							["get", prop],100
						]
					]
				],"% ",
				// ["to-string",["get", `${prop}Vol`]],

			]
		)
		.setFilter(
			'stranded-volume', 
			onlyWithLoss
		)
		.setPaintProperty(
			'stranded-volume', 
			'fill-extrusion-height',
			[ 
				"/", 
				["*",["get",`${prop}Vol`],1000000],
				100
			]
		)
		.setPaintProperty(
			'stranded-volume', 
			'fill-extrusion-color',
			colorRamp
		)

		console.log(prop)
		// tooltip.remove()

    }
    


    map.on('load', ()=> {

    	updateVis(); 
    	updateVis('visualize');
    	setupBarGraphLayers();
		d3.json('data/countyData.json', (e,r) => {

			const countyData = processCountyData(r);

			map.on('click', e => {

				tooltip.remove();

				const h = map.queryRenderedFeatures(e.point, {layers:['county-hittest']});

				if (h[0]) {

					const props = h[0].properties;
					const pole = JSON.parse(props.pole).map(s=>parseFloat(s));



					map.easeTo({
						center:[pole[0], pole[1]+0.05], 
						duration:600, 
						zoom: 11, 
						pitch: 45,
						easing:t=>t
					});

					d3.select('#countyLabel')
						.text(countyAppend(props))

					d3.select('#stateLabel')
						.text(props.s)
					const location = `${props.s}_${props.c}`;
					state.countyData = countyData[location];
					state.countyData.location = location;

					const barGeometry = generateBarGeometry(
						{lng:pole[0], lat:pole[1]}, 
						0.03, 
						state.countyData
					);

					state.view = 'county';
					updateVis('view');

					map.once('moveend', ()=> updateBarGraphLayers())
				





				}

			})
		})
    })
    .on('mousemove', e => {

    	if (state.view === 'county') {

			const h = map.queryRenderedFeatures(e.point);
			const bar = h.find(l=>l.layer.type ==='fill-extrusion');

			if (!bar) {
				tooltip.remove();
				if (state.currentBarIndex>=0){
					state.currentBarIndex = undefined;
					updateBarGraphColors()
				}
				return
			}

			tooltip
				.setLngLat(map.unproject(e.point));

			const barIndex = bar.properties.bar;

			// exit if same highlight as before
			if (barIndex === state.currentBarIndex) return
			tooltip
				.addTo(map)

			if (Math.abs(e.originalEvent.movementX)>20 ||Math.abs(e.originalEvent.movementY)>20 ) return
			state.currentBarIndex = barIndex;

			const scenario = constants.graphRows[Math.floor(barIndex/constants.graphRows.length)];
			const decade = barIndex % constants.graphRows.length
			const number = state.countyData[state.statistic][scenario][decade]
			tooltip.setHTML(`<div class="txt-h5">${formatStatistic[state.statistic](number)}</div>`)

			updateBarGraphColors(scenario, decade)
    	}

    	else {

			const h = map.queryRenderedFeatures(e.point, {layers:['county-hittest']});

			if (h[0]) {

				const props = h[0].properties;
				const stat = Math.round(props[state.product+state.scenario])
				
				tooltip
					.setHTML(`${countyAppend(props)} ${props.s}`)
					.setLngLat(map.unproject(e.point))
					.addTo(map)   
			}

			else tooltip.remove()
 		
    	}
    })


</script>

</body>
</html>